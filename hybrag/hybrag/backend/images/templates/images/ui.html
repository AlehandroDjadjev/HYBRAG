<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HYBRAG Console</title>
    <style>
      :root {
        --bg: #0b1220;
        --panel: #101829;
        --panel-2: #0d1424;
        --text: #e6edf3;
        --muted: #9fb0c3;
        --primary: #5b8cff;
        --primary-2: #3b6fff;
        --border: #1e2a43;
      }
      * { box-sizing: border-box; }
      body { font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: var(--text); background: radial-gradient(1200px 600px at 20% 0%, #13203a 0%, var(--bg) 50%); }
      .topbar { display: flex; align-items: center; justify-content: space-between; padding: 14px 20px; border-bottom: 1px solid var(--border); background: linear-gradient(180deg, #0f1a30, #0b1220); position: sticky; top: 0; z-index: 10; }
      .brand { font-weight: 700; letter-spacing: .4px; }
      .brand b { color: var(--primary); }
      .badge { display: inline-block; background: #1e2a43; color: var(--muted); border: 1px solid var(--border); padding: 2px 8px; border-radius: 999px; font-size: 12px; }
      .layout { display: grid; grid-template-columns: 220px 1fr; gap: 18px; max-width: 1200px; margin: 0 auto; padding: 24px; }
      @media (max-width: 920px) { .layout { grid-template-columns: 1fr; } }
      .sidebar { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 12px; height: fit-content; position: sticky; top: 76px; }
      .navbtn { width: 100%; text-align: left; padding: 10px 12px; background: var(--panel-2); border: 1px solid var(--border); border-radius: 10px; color: var(--text); margin-bottom: 8px; cursor: pointer; }
      .navbtn:hover { border-color: var(--primary); }
      .navbtn.active { background: #162344; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(91,140,255,.15) inset; }
      .content { min-width: 0; }
      .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.25); margin-bottom: 18px; }
      .card h2 { margin: 0 0 10px; font-size: 18px; }
      label { display: block; margin-top: 8px; color: var(--muted); font-size: 13px; }
      input, select, textarea { width: 100%; padding: 10px 12px; margin-top: 6px; color: var(--text); background: var(--panel-2); border: 1px solid var(--border); border-radius: 10px; outline: none; }
      input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(91,140,255,.15); }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      @media (max-width: 720px) { .row { grid-template-columns: 1fr; } }
      .btn { margin-top: 12px; padding: 10px 14px; background: var(--primary); color: #fff; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; }
      .btn:hover { background: var(--primary-2); }
      .btn.secondary { background: #2a3b5e; }
      .btn.secondary:hover { background: #334872; }
      .inline { display: inline-flex; gap: 8px; align-items: center; }
      .logbox { background: var(--panel-2); border: 1px solid var(--border); border-radius: 10px; padding: 12px; overflow: auto; color: var(--muted); margin-top: 10px; }
      .results { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; margin-top: 12px; }
      .img { width: 100%; height: 180px; object-fit: cover; border-radius: 10px; border: 1px solid var(--border); background: #0a0f1c; }
      .badge { display: inline-block; background: #1e2a43; color: var(--muted); border: 1px solid var(--border); padding: 2px 8px; border-radius: 999px; font-size: 12px; margin-right: 6px; }
      details { margin-top: 10px; }
      details > summary { cursor: pointer; color: var(--muted); }
      .hidden { display: none; }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="brand">HYBRAG <b>Media Finder</b></div>
      <div class="badge">v1</div>
    </div>

    <div class="layout">
      <div class="sidebar">
        <button class="navbtn active" onclick="switchSection('sec-search', this)">Find Images</button>
        <button class="navbtn" onclick="switchSection('sec-upsert', this)">Add One Image</button>
        <button class="navbtn" onclick="switchSection('sec-bulk', this)">Add Many Images</button>
      </div>

      <div class="content">
        <section id="sec-search" class="card">
          <h2>Find Images</h2>
          <div class="row">
            <div>
              <label>Describe what youâ€™re looking for</label>
              <input id="search-q" placeholder="e.g., red brick wall, tower crane" />
            </div>
            <div>
              <label>Project / Building (optional)</label>
              <input id="search-building" placeholder="e.g., Site A" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>From date (optional)</label>
              <input id="search-date-from" type="date" />
            </div>
            <div>
              <label>To date (optional)</label>
              <input id="search-date-to" type="date" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Number of results</label>
              <input id="search-k" type="number" value="5" />
            </div>
            <div>
              <label>Group (advanced)</label>
              <input id="search-namespace" placeholder="Leave empty unless instructed" />
            </div>
          </div>
          <button class="btn" onclick="search()">Search now</button>
          <div class="results" id="search-results"></div>
        </section>

        <section id="sec-upsert" class="card hidden">
          <h2>Add one image</h2>
          <div class="row">
            <div>
              <label>Image ID (auto-generate or paste your own)</label>
              <div class="inline" style="width:100%">
                <input id="upsert-id" placeholder="uuid-or-string" style="flex:1" />
                <button class="btn secondary" type="button" onclick="genId()">Generate</button>
              </div>
            </div>
            <div>
              <label>Select image file from your computer</label>
              <input id="single-file" type="file" accept="image/*" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Project / Building</label>
              <input id="upsert-building" placeholder="e.g., Site A" />
            </div>
            <div>
              <label>Photo date</label>
              <input id="upsert-date" type="date" />
            </div>
          </div>
          <label>Notes (optional)</label>
          <textarea id="upsert-notes" rows="2"></textarea>
          <button class="btn" onclick="upsert()">Add image</button>
          <div class="logbox" id="upsert-out"></div>

          <details>
            <summary>Advanced options</summary>
            <div class="row">
              <div>
                <label>S3 key (path/filename.jpg)</label>
                <input id="presign-key" placeholder="uploads/example.jpg" />
              </div>
              <div>
                <label>Content-Type</label>
                <select id="presign-ct">
                  <option value="image/jpeg">image/jpeg</option>
                  <option value="image/png">image/png</option>
                  <option value="image/webp">image/webp</option>
                </select>
              </div>
            </div>
            <button class="btn secondary" onclick="presign()" type="button">Presign PUT</button>
            <div class="logbox" id="presign-out"></div>
          </details>
        </section>

        <section id="sec-bulk" class="card hidden">
          <h2>Add many images</h2>
          <div class="row">
            <div>
              <label>Folder name in cloud (optional)</label>
              <input id="bulk-prefix" placeholder="auto picks folder names if empty" />
            </div>
            <div>
              <label>How many to upload at once</label>
              <input id="bulk-concurrency" type="number" value="3" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Project / Building (for all)</label>
              <input id="bulk-building" placeholder="e.g., Site A" />
            </div>
            <div>
              <label>Photo date (for all)</label>
              <input id="bulk-date" type="date" />
            </div>
          </div>
          <label>Notes (for all, optional)</label>
          <textarea id="bulk-notes" rows="2"></textarea>
          <label>Select a folder of images from your computer</label>
          <input id="bulk-input" type="file" webkitdirectory multiple />
          <button class="btn" onclick="bulkUpload()">Start upload</button>
          <div class="logbox" id="bulk-log"></div>
        </section>
      </div>
    </div>

    <script>
      function switchSection(id, btn) {
        document.querySelectorAll('.content > section').forEach(s => s.classList.add('hidden'));
        const el = document.getElementById(id);
        if (el) el.classList.remove('hidden');
        document.querySelectorAll('.navbtn').forEach(b => b.classList.remove('active'));
        if (btn) btn.classList.add('active');
      }

      async function presign() {
        const key = document.getElementById('presign-key').value.trim();
        const ct = document.getElementById('presign-ct').value.trim() || 'image/jpeg';
        const r = await fetch('/api/presign-upload', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({key, content_type: ct})});
        const j = await r.json();
        document.getElementById('presign-out').textContent = JSON.stringify(j, null, 2);
      }

      function genId() {
        const el = document.getElementById('upsert-id');
        const v = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now() + '-' + Math.random().toString(16).slice(2));
        el.value = v;
      }

      async function upsert() {
        const id = document.getElementById('upsert-id').value.trim();
        const file = (document.getElementById('single-file').files || [])[0];
        const building = document.getElementById('upsert-building').value.trim();
        const shot_date = document.getElementById('upsert-date').value.trim();
        const notes = document.getElementById('upsert-notes').value;
        if (!file) { document.getElementById('upsert-out').textContent = 'Please choose an image file.'; return; }
        const form = new FormData();
        form.append('file', file);
        form.append('building', building);
        form.append('shot_date', shot_date);
        form.append('notes', notes);
        const r = await fetch('/api/images', {method:'POST', body: form});
        const j = await r.json();
        document.getElementById('upsert-out').textContent = JSON.stringify(j, null, 2);
      }

      async function search() {
        const params = new URLSearchParams();
        const q = document.getElementById('search-q').value.trim();
        const building = document.getElementById('search-building').value.trim();
        const date_from = document.getElementById('search-date-from').value.trim();
        const date_to = document.getElementById('search-date-to').value.trim();
        const k = document.getElementById('search-k').value.trim();
        const namespace = document.getElementById('search-namespace').value.trim();
        if (q) params.set('q', q);
        if (building) params.set('building', building);
        if (date_from) params.set('date_from', date_from);
        if (date_to) params.set('date_to', date_to);
        if (k) params.set('k', k);
        if (namespace) params.set('namespace', namespace);
        const url = '/api/search?' + params.toString();
        const r = await fetch(url);
        const j = await r.json();
        const box = document.getElementById('search-results');
        box.innerHTML = '';
        const arr = ((j && j.results) || []).slice();
        arr.sort((a, b) => Number(b.score || 0) - Number(a.score || 0));
        arr.forEach((it, idx) => {
          const card = document.createElement('div');
          card.className = 'card';
          const imgUrl = it.image_url || '';
          const rank = idx + 1;
          card.innerHTML = `<img class="img" src="${imgUrl}" alt=""/>
<div><span class="badge">#${rank}</span> <span class="badge">${Number(it.score || 0).toFixed(3)}</span></div>
<div><b>${it.building || ''}</b> | ${it.shot_date || ''}</div>
<div>${(it.notes||'').slice(0,120)}</div>`;
          box.appendChild(card);
        });
      }

      function logBulk(msg) {
        const el = document.getElementById('bulk-log');
        el.textContent += msg + "\n";
        el.scrollTop = el.scrollHeight;
      }

      async function presignOne(key, contentType) {
        const r = await fetch('/api/presign-upload', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({key, content_type: contentType || 'image/jpeg'})});
        if (!r.ok) throw new Error('presign failed ' + r.status);
        return r.json();
      }

      async function putToS3(url, file, contentType) {
        const r = await fetch(url, {method: 'PUT', headers: {'Content-Type': contentType || 'application/octet-stream'}, body: file});
        if (!r.ok) throw new Error('s3 put failed ' + r.status);
      }

      async function upsertOne(id, s3_key, building, shot_date, notes) {
        const r = await fetch('/api/images/upsert-s3', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id, s3_key, building, shot_date, notes})});
        if (!r.ok) throw new Error('upsert failed ' + r.status);
        return r.json();
      }

      async function bulkUpload() {
        const files = Array.from(document.getElementById('bulk-input').files || []);
        if (!files.length) { logBulk('No files selected.'); return; }
        const prefix = (document.getElementById('bulk-prefix').value || '').trim();
        const building = (document.getElementById('bulk-building').value || '').trim();
        const shot_date = (document.getElementById('bulk-date').value || '').trim();
        const notes = document.getElementById('bulk-notes').value || '';
        const concurrency = Math.max(1, parseInt(document.getElementById('bulk-concurrency').value || '3', 10));

        logBulk(`Starting bulk: ${files.length} files, prefix="${prefix}"`);

        let idx = 0; let inFlight = 0; let done = 0;
        return new Promise((resolve) => {
          const next = () => {
            if (idx >= files.length && inFlight === 0) { logBulk('Bulk completed.'); resolve(); return; }
            while (inFlight < concurrency && idx < files.length) {
              const file = files[idx++];
              inFlight++;
              (async () => {
                try {
                  if (!file.type.startsWith('image/')) { logBulk(`Skip non-image: ${file.name}`); return; }
                  const rel = file.webkitRelativePath || file.name;
                  const key = (prefix ? prefix.replace(/\/+$/,'') + '/' : '') + rel.replace(/^\/+/, '');
                  logBulk(`Presign: ${key}`);
                  const ps = await presignOne(key, file.type);
                  await putToS3(ps.url, file, file.type);
                  const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now() + '-' + Math.random().toString(16).slice(2));
                  await upsertOne(id, key, building, shot_date, notes);
                  done++; logBulk(`OK (${done}/${files.length}): ${rel}`);
                } catch (e) {
                  logBulk(`ERR: ${e && e.message ? e.message : e}`);
                } finally { inFlight--; next(); }
              })();
            }
          };
          next();
        });
      }

      // default
      switchSection('sec-search');
    </script>
  </body>
</html>


